# Global variables
variables:
  RELEASE_COMMIT_PATTERN: /^chore\(release\)/
  MERGE_COMMIT_PATTERN: /^Merge branch/
  REGISTRY_URL: registry.inker.studio
  CONTAINER_TEST_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:$CI_COMMIT_REF_SLUG
  CONTAINER_RELEASE_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:latest

# NodeJS Job
.node-job:
  image: node:21.7.3-alpine
  cache:
    key:
      prefix: $CI_PROJECT_NAME
      files:
        - package-lock.json
    paths:
      - .npm/
    policy: pull
  before_script:
    - npm ci --cache .npm --prefer-offline

# Docker Job
.docker-job:
  image: docker:24.0.7-dind
  services:
    - docker:24.0.7-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $REGISTRY_URL


# Setup Job
.setup-job:
  extends: [.node-job]
  cache:
    key: !reference [.node-job, cache, key]
    paths: !reference [.node-job, cache, paths]
    policy: pull-push

# Verify Job
.verify-job:
  extends: [.node-job]
  before_script:
    - apk add --no-cache git
    - !reference [.node-job, before_script]
  script:
    - npm run prettier
    - npm run lint
    - npm run test
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

# Semantic Release Job
.release-job:
  extends: [.node-job]
  before_script:
    - apk add --no-cache git
    - npm install -g semantic-release @semantic-release/gitlab @semantic-release/git @semantic-release/changelog
  script:
    - semantic-release
  artifacts:
    paths:
      - CHANGELOG.md

# Merge Request Rules
.mr-rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always

# Master Rules
.master-rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "master" && $CI_COMMIT_MESSAGE !~ $RELEASE_COMMIT_PATTERN
      when: always

# Release Rules
.release-rules:
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_MESSAGE =~ $RELEASE_COMMIT_PATTERN
      when: always