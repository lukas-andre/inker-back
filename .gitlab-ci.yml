# File: .gitlab-ci.yml
include:
  - local: .gitlab/base.yml
  - local: .gitlab/rules.yml
  - local: .gitlab/cache.yml

stages:
  - setup
  - verify
  - build
  - release
  - deploy

variables:
  RELEASE_COMMIT_PATTERN: /^chore\(release\)/
  MERGE_COMMIT_PATTERN: /^Merge branch/
  REGISTRY_URL: registry.inker.studio
  CONTAINER_TEST_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:$CI_COMMIT_REF_SLUG
  CONTAINER_RELEASE_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:latest
  BUILDKIT_PROGRESS: plain
  DOCKER_BUILDKIT: "1"
  COMPOSE_DOCKER_CLI_BUILD: "1"

default:
  tags:
    - inker
  interruptible: true
  timeout: 30m

# Stage: Setup
Install Dependencies:
  stage: setup
  extends: 
    - .node-job
    - .setup-cache
  script:
    - npm ci --prefer-offline --no-audit
    - npm run prepare || true
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 day
  rules:
    - !reference [.changes-package, rules]

# Stage: Verify
Verify:
  stage: verify
  extends: 
    - .node-job
    - .verify-cache
  needs: ["Install Dependencies"]
  dependencies:
    - Install Dependencies
  script:
    # - npm run lint
    # - npm run test -- --ci --coverage || true
    - npm run build --configuration production  # Agregamos configuración de producción
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - dist/     # Solo guardamos los archivos necesarios para producción
      - coverage/
    expire_in: 1 day
  rules:
    - !reference [.changes-src, rules]

# Stage: Build
Build Image:
  stage: build
  extends: .docker-job
  needs: ["Verify"]
  dependencies:
    - Verify
  script:
    - docker build -t $BRANCH_TAG -t $SHA_TAG .
    - docker push $BRANCH_TAG
    - docker push $SHA_TAG
  rules:
    - !reference [.changes-docker, rules]

Deploy to Production:
  stage: deploy
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  dependencies:
    - Build Image
  variables:
    # Docker configuration
    DOCKER_HOST: tcp://gitlab-dind:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    # Application configuration
    PORT: 3000
    DB_HOST: ${DB_HOST}
    DB_PASSWORD: ${DB_PASSWORD}
    DB_USERNAME: ${DB_USERNAME}
    DB_PORT: ${DB_PORT}
    TYPEORM_SYNC: ${TYPEORM_SYNC}
    AWS_ACCESS_KEY: ${AWS_ACCESS_KEY}
    AWS_ACCESS_SECRET: ${AWS_ACCESS_SECRET}
    SMS_AWS_ACCESS_KEY: ${SMS_AWS_ACCESS_KEY}
    SMS_AWS_ACCESS_SECRET: ${SMS_AWS_ACCESS_SECRET}
    AWS_REGION: ${AWS_REGION}
    AWS_ARTISTS_BUCKET: ${AWS_ARTISTS_BUCKET}
    CLOUD_FRONT_URL: ${CLOUD_FRONT_URL}
    JWT_ISSUER: ${JWT_ISSUER}
    JWT_SECRET_KEY: ${JWT_SECRET_KEY}
    JWT_EXPIRATION: ${JWT_EXPIRATION}
    TZ: "America/Santiago"
    VERIFICATION_HASH_SALT_LEN: ${VERIFICATION_HASH_SALT_LEN}
    ACCOUNT_VERIFICATION_MAX_SMS_TRIES: ${ACCOUNT_VERIFICATION_MAX_SMS_TRIES}
    FORGOT_PASSWORD_VERIFICATION_MAX_SMS_TRIES: ${FORGOT_PASSWORD_VERIFICATION_MAX_SMS_TRIES}
    GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS}
  script:    
    - cd /apps/api
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $REGISTRY_URL
    - |
      PORT=${PORT} \
      DB_HOST=${DB_HOST} \
      DB_PASSWORD=${DB_PASSWORD} \
      DB_USERNAME=${DB_USERNAME} \
      DB_PORT=${DB_PORT} \
      TYPEORM_SYNC=${TYPEORM_SYNC} \
      AWS_ACCESS_KEY=${AWS_ACCESS_KEY} \
      AWS_ACCESS_SECRET=${AWS_ACCESS_SECRET} \
      SMS_AWS_ACCESS_KEY=${SMS_AWS_ACCESS_KEY} \
      SMS_AWS_ACCESS_SECRET=${SMS_AWS_ACCESS_SECRET} \
      AWS_REGION=${AWS_REGION} \
      AWS_ARTISTS_BUCKET=${AWS_ARTISTS_BUCKET} \
      CLOUD_FRONT_URL=${CLOUD_FRONT_URL} \
      JWT_ISSUER=${JWT_ISSUER} \
      JWT_SECRET_KEY=${JWT_SECRET_KEY} \
      JWT_EXPIRATION=${JWT_EXPIRATION} \
      TZ=${TZ} \
      VERIFICATION_HASH_SALT_LEN=${VERIFICATION_HASH_SALT_LEN} \
      ACCOUNT_VERIFICATION_MAX_SMS_TRIES=${ACCOUNT_VERIFICATION_MAX_SMS_TRIES} \
      FORGOT_PASSWORD_VERIFICATION_MAX_SMS_TRIES=${FORGOT_PASSWORD_VERIFICATION_MAX_SMS_TRIES} \
      CI_COMMIT_SHA=${CI_COMMIT_SHA} \
      docker compose -f docker-compose.yml up -d
  rules:
    - !reference [.changes-docker, rules]

# Stage: Release
Create Release:
  stage: release
  extends: .release-job
  needs: ["Build Image"]
  script:
    - apk add --no-cache git openssh-client
    - npm install -g semantic-release @semantic-release/gitlab @semantic-release/git @semantic-release/changelog
    - npx semantic-release  # Agregamos el comando que realmente ejecuta semantic-release
  rules:
    - !reference [.release-branch, rules]

Push Release Image:
  stage: release
  extends: .docker-job
  needs: ["Create Release"]
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker push $CONTAINER_RELEASE_IMAGE
  rules:
    - !reference [.release-tag, rules]

