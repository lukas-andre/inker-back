include:
  - local: .gitlab/templates.yml

variables:
  CONTAINER_TEST_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:$CI_COMMIT_REF_SLUG
  CONTAINER_RELEASE_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:latest

stages:
  - setup
  - verify
  - build
  - release
  - deploy

# Stage: Setup
Install Dependencies:
  stage: setup
  extends: [.setup-job]
  rules:
    - !reference [.mr-rules, rules]
    - !reference [.master-rules, rules]

# Stage: Verify
Verify:
  stage: verify
  extends: [.verify-job]
  needs: ["Install Dependencies"]
  rules:
    - !reference [.mr-rules, rules]
    - !reference [.master-rules, rules]

# Stage: Build
Build Image:
  stage: build
  extends: [.docker-job]
  needs: ["Verify"]
  script:
    - docker pull $CONTAINER_TEST_IMAGE || true
    - |
      docker build \
        --cache-from $CONTAINER_TEST_IMAGE \
        --build-arg NODE_ENV=production \
        --label "org.opencontainers.image.title=$CI_PROJECT_TITLE" \
        --label "org.opencontainers.image.url=$CI_PROJECT_URL" \
        --label "org.opencontainers.image.created=$CI_JOB_STARTED_AT" \
        --label "org.opencontainers.image.revision=$CI_COMMIT_SHA" \
        --label "org.opencontainers.image.version=$CI_COMMIT_REF_NAME" \
        --tag $CONTAINER_TEST_IMAGE \
        .
    - docker push $CONTAINER_TEST_IMAGE
  rules:
    - !reference [.mr-rules, rules]
    - !reference [.master-rules, rules]

# Stage: Release
Create Release:
  stage: release
  extends: [.release-job]
  needs: ["Build Image"]
  rules:
    - !reference [.master-rules, rules]

Push Release Image:
  stage: release
  extends: [.docker-job]
  needs: ["Create Release"]
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker push $CONTAINER_RELEASE_IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH == "master" && $CI_COMMIT_MESSAGE =~ $RELEASE_COMMIT_PATTERN

# Stage: Deploy
Deploy to Production:
  stage: deploy
  image: alpine:3.19
  script:
    - echo "Deploying version $CI_COMMIT_TAG"
    # Aquí irían los comandos de despliegue
  rules:
    - !reference [.release-rules, rules]