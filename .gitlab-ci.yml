include:
  - local: .gitlab/templates.yml

stages:
  - setup
  - verify
  - build
  - release
  - deploy

default:
  tags:
    - inker

# Stage: Setup
Install Dependencies:
  stage: setup
  extends: [.node-job]
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run prepare || true  # Para husky (opcional)
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "master" && $CI_COMMIT_MESSAGE !~ $RELEASE_COMMIT_PATTERN
      when: always

# Stage: Verify
Verify:
  stage: verify
  extends: [.node-job]
  needs: ["Install Dependencies"]
  before_script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run prettier
    # - npm run test || true  # Hacemos opcional los tests por ahora
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "master" && $CI_COMMIT_MESSAGE !~ $RELEASE_COMMIT_PATTERN
      when: always

# Stage: Build
Build Image:
  stage: build
  extends: [.docker-job]
  needs: ["Verify"]
  script:
    - docker pull $CONTAINER_TEST_IMAGE || true
    - |
      docker build \
        --cache-from $CONTAINER_TEST_IMAGE \
        --build-arg NODE_ENV=production \
        --label "org.opencontainers.image.title=$CI_PROJECT_TITLE" \
        --label "org.opencontainers.image.url=$CI_PROJECT_URL" \
        --label "org.opencontainers.image.created=$CI_JOB_STARTED_AT" \
        --label "org.opencontainers.image.revision=$CI_COMMIT_SHA" \
        --label "org.opencontainers.image.version=$CI_COMMIT_REF_NAME" \
        --tag $CONTAINER_TEST_IMAGE \
        .
    - docker push $CONTAINER_TEST_IMAGE
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "master" && $CI_COMMIT_MESSAGE !~ $RELEASE_COMMIT_PATTERN
      when: always

# Stage: Release
Create Release:
  stage: release
  image: node:21.7.3-alpine
  needs: ["Build Image"]
  before_script:
    - apk add --no-cache git
    - npm install -g semantic-release @semantic-release/gitlab @semantic-release/git @semantic-release/changelog
  script:
    - semantic-release
  artifacts:
    paths:
      - CHANGELOG.md
  rules:
    - if: $CI_COMMIT_BRANCH == "master" && $CI_COMMIT_MESSAGE !~ $RELEASE_COMMIT_PATTERN
      when: always

Push Release Image:
  stage: release
  extends: [.docker-job]
  needs: ["Create Release"]
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker push $CONTAINER_RELEASE_IMAGE
  rules:
    - if: $CI_COMMIT_BRANCH == "master" && $CI_COMMIT_MESSAGE =~ $RELEASE_COMMIT_PATTERN
      when: always

# Stage: Deploy
Deploy to Production:
  stage: deploy
  image: alpine:3.19
  script:
    - echo "Deploying version $CI_COMMIT_TAG"
    # Aquí irían los comandos de despliegue a producción
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_MESSAGE =~ $RELEASE_COMMIT_PATTERN
      when: always