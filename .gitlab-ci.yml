# File: .gitlab-ci.yml
include:
  - local: .gitlab/base.yml
  - local: .gitlab/rules.yml
  - local: .gitlab/cache.yml

stages:
  - setup
  - verify
  - build
  - release
  - deploy

variables:
  RELEASE_COMMIT_PATTERN: /^chore\(release\)/
  MERGE_COMMIT_PATTERN: /^Merge branch/
  REGISTRY_URL: registry.inker.studio
  CONTAINER_TEST_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:$CI_COMMIT_REF_SLUG
  CONTAINER_RELEASE_IMAGE: $REGISTRY_URL/$CI_PROJECT_PATH:latest
  BUILDKIT_PROGRESS: plain
  DOCKER_BUILDKIT: "1"
  COMPOSE_DOCKER_CLI_BUILD: "1"

default:
  tags:
    - inker
  interruptible: true
  timeout: 30m

# Stage: Setup
Install Dependencies:
  stage: setup
  extends: 
    - .node-job
    - .setup-cache
  script:
    - npm ci --prefer-offline --no-audit
    - npm run prepare || true
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 day
  rules:
    - !reference [.changes-package, rules]

# Stage: Verify
.verify-base:
  stage: verify
  extends: 
    - .node-job
    - .verify-cache
  needs: ["Install Dependencies"]
  dependencies:
    - Install Dependencies
  cache:
    policy: pull

Verify:
  stage: verify
  extends: 
    - .node-job
    - .verify-cache
  needs: ["Install Dependencies"]
  dependencies:
    - Install Dependencies
  script:
    - npm run lint
    - npm run test -- --ci --coverage || true
    - npm run build --configuration production
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - dist/
      - coverage/
    expire_in: 1 day
  rules:
    - !reference [.changes-src, rules]

# Stage: Build
Build Image:
  stage: build
  extends: .docker-job
  needs: ["Verify"] 
  dependencies:
    - Verify
  script:
    - docker buildx create --use
    - |
      IMAGE_SIZE=$(docker buildx build \
        --load \
        --build-arg NODE_ENV=production \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHA \
        --label "org.opencontainers.image.created=$CI_JOB_STARTED_AT" \
        --label "org.opencontainers.image.version=$CI_COMMIT_REF_NAME" \
        --label "org.opencontainers.image.revision=$CI_COMMIT_SHA" \
        --label "org.opencontainers.image.title=$CI_PROJECT_TITLE" \
        --label "org.opencontainers.image.url=$CI_PROJECT_URL" \
        --label "org.opencontainers.image.source=$CI_PROJECT_URL" \
        --tag $CONTAINER_TEST_IMAGE \
        . 2>&1 | grep "total:" | awk '{print $2$3}')
    - echo "Image size: $IMAGE_SIZE"
    - |
      if [ "${IMAGE_SIZE%MB}" -lt 200 ]; then
        docker buildx build \
          --push \
          --cache-from type=registry,ref=$CONTAINER_TEST_IMAGE \
          --cache-to type=registry,ref=$CONTAINER_TEST_IMAGE \
          --build-arg NODE_ENV=production \
          --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --build-arg VCS_REF=$CI_COMMIT_SHA \
          --label "org.opencontainers.image.created=$CI_JOB_STARTED_AT" \
          --label "org.opencontainers.image.version=$CI_COMMIT_REF_NAME" \
          --label "org.opencontainers.image.revision=$CI_COMMIT_SHA" \
          --label "org.opencontainers.image.title=$CI_PROJECT_TITLE" \
          --label "org.opencontainers.image.url=$CI_PROJECT_URL" \
          --label "org.opencontainers.image.source=$CI_PROJECT_URL" \
          --tag $CONTAINER_TEST_IMAGE \
          .
      else
        echo "Image size ($IMAGE_SIZE) exceeds limit"
        exit 1
      fi
  rules:
    - !reference [.changes-docker, rules]

# Stage: Release
Create Release:
  stage: release
  extends: .release-job
  needs: ["Build Image"]
  script:
    - apk add --no-cache git openssh-client
    - npm install -g semantic-release @semantic-release/gitlab @semantic-release/git @semantic-release/changelog
    - npx semantic-release  # Agregamos el comando que realmente ejecuta semantic-release
  rules:
    - !reference [.release-branch, rules]

Push Release Image:
  stage: release
  extends: .docker-job
  needs: ["Create Release"]
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker push $CONTAINER_RELEASE_IMAGE
  rules:
    - !reference [.release-tag, rules]

# Stage: Deploy
Deploy to Production:
  stage: deploy
  image: alpine:3.19
  script:
    - echo "Deploying version $CI_COMMIT_TAG"
    # Add your deployment commands here
  rules:
    - !reference [.release-tag, rules]
